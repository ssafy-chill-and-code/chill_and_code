<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.chillandcode.model.dao.PostDao">

	<!-- 게시글 작성 -->
	<insert id="insert" parameterType="Post" useGeneratedKeys="true"
		keyProperty="postId">
		INSERT INTO post(user_id, title, content, region)
		VALUES(#{userId}, #{title}, #{content}, #{region})
	</insert>

	<!-- 게시글 목록 조회 -->
	<select id="selectAll" parameterType="map" resultType="Post">
		SELECT
		p.post_id,
		p.user_id,
		p.title,
		p.content,
		p.region,
		p.created_at,
		u.nickname,
		u.profile_image_url,
		COALESCE(p.view_count, 0) AS view_count,
		COALESCE((SELECT COUNT(*) FROM comment c WHERE c.post_id = p.post_id), 0) AS comment_count
		FROM post p
		LEFT JOIN users u ON p.user_id = u.user_id
		<where>
			<!-- 지역 필터 -->
			<if test="region != null and region != ''">
				p.region = #{region}
			</if>

			<!-- 검색(제목+내용) -->
			<if test="search != null and search != ''">
				AND (p.title LIKE CONCAT('%', #{search}, '%')
				OR p.content LIKE CONCAT('%', #{search}, '%'))
			</if>
		</where>

		<!-- 정렬 -->
		<choose>
			<when test="sort == 'latest'">
				ORDER BY p.created_at DESC
			</when>
			<when test="sort == 'oldest'">
				ORDER BY p.created_at ASC
			</when>
			<when test="sort == 'popular'">
				ORDER BY comment_count DESC
			</when>
			<otherwise>
				ORDER BY p.created_at DESC
			</otherwise>
		</choose>

		<!-- 페이징 -->
		LIMIT #{limit} OFFSET #{offset}
	</select>


	<!-- 내가 쓴 게시글 조회 -->
	<select id="selectByUserId" parameterType="Long"
		resultType="Post">
		SELECT
		p.post_id,
		p.user_id,
		p.title,
		p.content,
		p.region,
		p.created_at,
		u.nickname,
		u.profile_image_url,
		COALESCE(p.view_count, 0) AS view_count,
		COALESCE((SELECT COUNT(*) FROM comment c WHERE c.post_id = p.post_id), 0) AS comment_count
		FROM
		post p
		LEFT JOIN users u ON p.user_id = u.user_id
		WHERE p.user_id = #{userId}
		ORDER BY p.created_at DESC
	</select>

	<!-- 게시글 상세 조회 -->
	<select id="selectById" resultType="Post">
		SELECT
		p.post_id,
		p.user_id,
		p.title,
		p.content,
		p.region,
		p.created_at,
		u.nickname,
		u.profile_image_url,
		COALESCE(p.view_count, 0) AS view_count,
		COALESCE((SELECT COUNT(*) FROM comment c WHERE c.post_id = p.post_id), 0) AS comment_count
		FROM post p
		LEFT JOIN users u ON p.user_id = u.user_id
		WHERE
		p.post_id = #{postId}
	</select>

	<!-- 게시글 수정 -->
	<update id="update" parameterType="Post">
		UPDATE post
		<set>
			<if test="title != null and title != ''">
				title = #{title},
			</if>
			<if test="content != null and content != ''">
				content = #{content},
			</if>
			<if test="region != null and region != ''">
				region = #{region},
			</if>
		</set>
		WHERE post_id = #{postId}
	</update>


	<!-- 게시글 삭제 -->
	<delete id="delete" parameterType="Long">
		DELETE FROM post
		WHERE post_id
		= #{postId}
</delete>

    <!-- 지역별 게시글 수 랭킹 조회 -->
    <select id="selectRegionRank" parameterType="map" resultType="com.ssafy.chillandcode.model.dto.post.RegionRank">
        SELECT region,
               COUNT(*) AS count
        FROM post
        WHERE region IS NOT NULL AND region &lt;&gt; ''
        <if test="windowDays != null">
            AND created_at &gt;= DATE_SUB(NOW(), INTERVAL #{windowDays} DAY)
        </if>
        GROUP BY region
        ORDER BY count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

	<!-- 조회수 증가 -->
	<update id="incrementViewCount" parameterType="Long">
		UPDATE post
		SET view_count = COALESCE(view_count, 0) + 1
		WHERE post_id = #{postId}
	</update>

	<!-- 게시글 총 개수 조회 (검색 조건 포함) -->
	<select id="countAll" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM post p
		<where>
			<!-- 지역 필터 -->
			<if test="region != null and region != ''">
				p.region = #{region}
			</if>

			<!-- 검색(제목+내용) -->
			<if test="search != null and search != ''">
				AND (p.title LIKE CONCAT('%', #{search}, '%')
				OR p.content LIKE CONCAT('%', #{search}, '%'))
			</if>
		</where>
	</select>

</mapper>
