<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.chillandcode.model.dao.review.ReviewDao">

	<!-- 장소명과 지역으로 리뷰 목록 조회 -->
	<select id="selectByPlaceName" parameterType="map" resultType="com.ssafy.chillandcode.model.dto.review.PlaceReviewResponse">
		SELECT
			r.id,
			r.user_id,
			r.rating,
			r.content,
			r.created_at,
			u.nickname,
			u.profile_image_url
		FROM place_review r
		LEFT JOIN users u ON r.user_id = u.user_id
		<where>
			r.place_name = #{placeName}
			<if test="region != null and region != ''">
				AND r.region = #{region}
			</if>
		</where>
		ORDER BY r.created_at DESC
	</select>

	<!-- 장소명과 지역으로 리뷰 개수 조회 -->
	<select id="countByPlaceName" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM place_review
		<where>
			place_name = #{placeName}
			<if test="region != null and region != ''">
				AND region = #{region}
			</if>
		</where>
	</select>

	<!-- 장소명과 지역으로 평균 별점 조회 -->
	<select id="selectAverageRating" parameterType="map" resultType="double">
		SELECT COALESCE(AVG(rating), 0.0)
		FROM place_review
		<where>
			place_name = #{placeName}
			<if test="region != null and region != ''">
				AND region = #{region}
			</if>
		</where>
	</select>

	<!-- 장소 리뷰 작성 -->
	<insert id="insert" parameterType="com.ssafy.chillandcode.model.dto.review.PlaceReview"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO place_review (place_name, region, rating, content, user_id)
		VALUES (#{placeName}, #{region}, #{rating}, #{content}, #{userId})
	</insert>

	<!-- 리뷰 ID로 리뷰 조회 -->
	<select id="selectById" parameterType="Long" resultType="com.ssafy.chillandcode.model.dto.review.PlaceReview">
		SELECT id, place_name, region, rating, content, user_id, created_at
		FROM place_review
		WHERE id = #{reviewId}
	</select>

	<!-- 장소 리뷰 수정 -->
	<update id="update" parameterType="com.ssafy.chillandcode.model.dto.review.PlaceReview">
		UPDATE place_review
		SET rating = #{rating}, content = #{content}
		WHERE id = #{id}
	</update>

	<!-- 장소 리뷰 삭제 -->
	<delete id="delete" parameterType="Long">
		DELETE FROM place_review
		WHERE id = #{reviewId}
	</delete>

</mapper>
